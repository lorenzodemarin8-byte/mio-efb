<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Flight App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* BASE & FONT */
        body { 
            font-family: "Aptos Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; padding: 0; 
            background: #F1F7FD; 
            height: 100vh; display: flex; flex-direction: column; 
        }
        .hidden { display: none !important; }

        /* HOME */
        #page-home { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; gap: 20px; max-width: 800px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        
        #home-date-header {
            color: #005EB8; 
            font-size: 28px; 
            font-weight: 300; 
            margin-bottom: 5px;
            letter-spacing: -0.5px;
        }

        .section-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        /* Box Full width */
        .section-box-full { 
            background: white; 
            padding: 0; 
            border-radius: 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            overflow: hidden; 
            margin-bottom: 50px; 
        }
        
        .margin-extra { margin-bottom: 80px !important; }

        .section-title { font-weight: 700; font-size: 14px; margin-bottom: 15px; color: #005EB8; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

        .btn-main-import { background-color: #2687E5; color: white; border: none; padding: 4px 10px; border-radius: 15px; font-size: 10px; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; }

        /* TABLES */
        #flight-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        #flight-table th { text-align: left; padding: 10px; border-bottom: 2px solid #e5e5ea; color: #005EB8; font-weight: normal; font-size: 11px; text-transform: uppercase; }
        #flight-table td { padding: 12px 10px; border-bottom: 1px solid #f2f2f7; color: #005EB8; font-weight: 600; }
        #flight-table tr:hover { background-color: #f2f2f7; cursor: pointer; }

        .crew-table { width: 100%; border-collapse: collapse; font-size: 13px; color: #005EB8; }
        .crew-table td { padding: 8px 0; border-bottom: 1px solid #f9f9f9; vertical-align: middle; }
        .crew-role { color: #005EB8; font-weight: normal; width: 40px; font-size: 11px; opacity: 0.8; font-style: normal !important; } 
        .crew-code { font-weight: 600; color: #005EB8; width: 80px; font-style: normal !important; } 
        .crew-name { font-weight: 600; color: #005EB8; font-style: normal !important; }

        /* MODAL */
        #import-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 15px; }
        .modal-title { font-weight: bold; font-size: 18px; }
        .modal-desc { font-size: 13px; color: #666; line-height: 1.4; }
        textarea#json-input { width: 100%; height: 150px; padding: 10px; border: 1px solid #d1d1d6; border-radius: 8px; font-family: monospace; font-size: 11px; resize: vertical; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .btn-cancel { background: #e5e5ea; color: #333; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-confirm { background: #34c759; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        /* DETAILS HEADER */
        #page-details { display: flex; flex-direction: column; height: 100vh; background: #F1F7FD; }
        #details-top-bar { padding: 10px 15px; background: #F1F7FD; display: flex; flex-direction: column; gap: 5px; flex-shrink: 0; }
        .nav-row { display: flex; justify-content: space-between; align-items: center; position: relative; height: 30px; }
        .btn-back-custom { background: none; border: none; padding: 0; color: #2687E5; font-size: 14px; font-weight: normal; cursor: pointer; font-family: inherit; }
        .page-title-center { position: absolute; left: 50%; transform: translateX(-50%); color: #000000; font-size: 17px; font-weight: 600; text-transform: uppercase; white-space: nowrap; z-index: 1; }
        
        .flight-header-row { 
            text-align: center; 
            color: #005EB8; 
            font-size: 13px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            padding-top: 5px; 
            letter-spacing: 0.5px; 
            font-weight: 400; 
        }
        .header-callsign { font-weight: 700; }
        
        #content-area { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        #ofp-text-container { background: white; padding: 15px; border-radius: 5px; font-family: "Courier New", Courier, monospace; font-size: 11px; white-space: pre-wrap; color: #333; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* BOTTOM NAV */
        #bottom-nav { display: grid; grid-template-columns: repeat(8, 1fr); background: #F1F7FD; border-top: 1px solid #ccc; padding: 0; height: 60px; z-index: 100; flex-shrink: 0; } 
        .nav-btn { background: transparent; border: none; display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 4px; padding: 0 2px; cursor: pointer; position: relative; border-top: 4px solid transparent; transition: all 0.1s; }
        .nav-icon { width: 20px; height: 20px; fill: #005EB8; flex-shrink: 0; }
        .nav-text { font-size: 11px; font-weight: 400; text-transform: uppercase; color: #D32F2F; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; letter-spacing: 0.3px; }
        .nav-btn:nth-of-type(2) .nav-text { color: #005EB8 !important; }
        .nav-btn.active { border-top: 4px solid #005EB8; background-color: rgba(0,0,0,0.03); }

        /* WEATHER MAPS */
        #view-weather { display: flex; flex-direction: column; height: 100%; width: 100%; overflow: hidden; }
        .weather-carousel { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; flex-grow: 1; scrollbar-width: none; -ms-overflow-style: none; scroll-behavior: smooth; }
        .weather-page { min-width: 100%; scroll-snap-align: start; overflow-y: auto; padding: 10px; box-sizing: border-box; background: transparent; flex-shrink: 0; position: relative; }
        .map-wrapper { display: flex; flex-direction: column; justify-content: flex-start; align-items: center; width: 100%; height: 100%; min-height: 400px; padding-top: 20px; }
        .wx-map-img { max-width: 98%; max-height: 60vh; width: auto; height: auto; object-fit: contain; display: block; background: white; margin-bottom: 15px; border: 1px solid #eee; }
        .btn-open-map { background-color: #005EB8; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 13px; text-transform: uppercase; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: block; text-align: center; }
        .weather-page:not(#wx-page-0) { display: flex !important; flex-direction: column; background-color: #F1F7FD; }
        .weather-dots { display: flex; justify-content: center; gap: 10px; padding: 10px 0; background: transparent; border-top: 1px solid rgba(0,0,0,0.05); flex-shrink: 0; }
        .dot { font-size: 18px; color: #ccc; cursor: pointer; transition: color 0.3s; line-height: 1; }
        .dot.active { color: #1c1c1e; text-shadow: 0 0 2px rgba(0,0,0,0.2); }

        /* WX COMPONENTS */
        .wx-airport-box { background: #FFFFFF; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; overflow: hidden; border: 1px solid rgba(0,0,0,0.05); }
        .wx-header-row { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .wx-info-left { display: flex; flex-direction: column; gap: 2px; }
        .wx-label { font-size: 10px; color: #000000; font-weight: normal; text-transform: uppercase; }
        .wx-codes { font-size: 14px; font-weight: 700; color: #005EB8; }
        .wx-name { font-size: 12px; color: #000000; }
        .btn-details { background: #F1F7FD; color: #000000; font-size: 11px; font-weight: bold; padding: 6px 12px; border-radius: 15px; cursor: pointer; border: none; display: flex; align-items: center; gap: 5px; }
        .chevron { display: inline-block; width: 6px; height: 6px; border-right: 2px solid #000; border-bottom: 2px solid #000; transform: rotate(45deg); margin-bottom: 2px; transition: transform 0.2s ease; }
        .chevron.up { transform: rotate(-135deg); margin-bottom: -2px; }
        .wx-details-area { display: none; padding: 15px; background: #FFFFFF; border-top: 1px solid #f2f2f7; }
        .wx-stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px; }
        .stat-box { display: flex; flex-direction: column; align-items: center; gap: 4px; text-align: center; }
        .stat-label { font-size: 10px; color: #666; text-transform: capitalize; font-weight: normal; }
        .stat-value { font-size: 13px; color: #000000; font-weight: 600; }
        .badge-weather { display: inline-block; padding: 2px 8px; border-radius: 6px; color: white; font-weight: bold; font-size: 11px; text-align: center; min-width: 35px; }
        .bg-green { background-color: #388E3C; } .bg-red { background-color: #D32F2F; }   
        .runway-section { border-top: 1px solid #eee; margin-top: 10px; padding-top: 15px; margin-bottom: 20px; display: flex; justify-content: space-around; }
        .rwy-box { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .rwy-label { font-size: 10px; color: #666; font-weight: normal; }
        .rwy-value { font-size: 13px; color: #000000; font-weight: 600; }
        .wind-val { font-size: 13px; font-weight: normal; color: #000; }
        .metar-container { border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; overflow: hidden; margin-bottom: 15px; font-family: inherit; }
        .metar-header { background-color: #2687E5; color: white; font-size: 11px; font-weight: bold; padding: 6px 10px; display: flex; justify-content: space-between; text-transform: uppercase; }
        .header-time { font-weight: normal; color: white; opacity: 0.9; }
        .metar-body { background-color: #F1F7FD; color: #333; font-family: inherit; font-size: 12px; padding: 12px; white-space: pre-wrap; line-height: 1.5; }

        /* FLIGHT LOG GRID STYLES */
        .log-container { 
            border-radius: 12px; 
            overflow: hidden; 
            margin-bottom: 40px; 
            background: white; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: none; 
        }
        .log-header { 
            background-color: #2687E5; 
            color: white; 
            font-size: 14px; 
            font-weight: 600; 
            padding: 8px 10px; 
            text-transform: uppercase; 
            display: flex; 
            justify-content: space-between; 
        }
        .log-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; font-size: 13px; }
        .log-cell { 
            padding: 10px; 
            text-align: center; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            min-height: 35px;
            border: none; 
        }
        .log-label { font-weight: bold; color: #005EB8; text-align: left; background-color: white; }
        .log-col-header { color: black; font-weight: normal; background-color: white; text-align: center;}
        .log-value-sched { color: #333; font-weight: 600; font-size: 14px; }
        .log-value-est { color: #666; font-style: italic; font-size: 13px; }
        .log-input { border: 1px solid #ccc; border-radius: 4px; padding: 6px; width: 90%; text-align: center; font-family: inherit; font-size: 14px; color: #000; font-weight: bold; box-sizing: border-box; background: #fff; }
        .log-calc-result { font-weight: bold; color: #005EB8; font-size: 14px; }
        
        /* FUEL PLANNING SUBPAGE STYLES */
        #subpage-fuel-plan, #subpage-dep-atis { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #F1F7FD; z-index: 200; display: flex; flex-direction: column; 
        }
        .fp-table { width: 100%; border-collapse: collapse; font-size: 13px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-top: 10px; }
        .fp-header-blue { background-color: #2687E5; color: white; font-weight: bold; font-size: 14px; text-transform: uppercase; padding: 8px 15px; }
        .fp-sub-header { background-color: white; color: black; font-weight: normal; border-bottom: 2px solid #666; text-align: left; }
        .fp-sub-header th { padding: 8px 15px; font-weight: normal; text-transform: uppercase; font-size: 11px; }
        .fp-row td { padding: 8px 15px; border-bottom: none; color: #333; font-weight: normal; } 
        .fp-row-divider td { border-bottom: 1px solid #ccc; padding: 0; height: 1px;} 
        .fp-input { border: 1px solid #ccc; padding: 5px; width: 100%; border-radius: 4px; font-weight: normal; box-sizing: border-box; }
        .fp-final-row td { background-color: white; padding: 15px; }
        
        .link-text { color: #2687E5; text-decoration: none; cursor: pointer; font-size: 14px; font-weight: normal; }
        .link-text:hover { text-decoration: underline; }

        .fp-page-title { 
            position: absolute; left: 50%; transform: translateX(-50%); 
            color: #000000; font-size: 17px; font-weight: 600; 
            white-space: nowrap; z-index: 1;
        }
        
        /* FUEL FMC MAIN GRID - UPDATED */
        .fuel-main-grid { 
            display: grid; grid-template-columns: 1fr 1fr 1fr; 
            background: white; 
            width: 100%;
        }
        .fuel-main-grid.cols-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
        .fuel-main-grid.cols-1 { grid-template-columns: 1fr; } 
        
        .fmg-header { 
            background-color: #2687E5; 
            color: white; 
            font-weight: 600; 
            font-size: 14px; 
            text-align: center; 
            padding: 8px; 
            text-transform: uppercase; 
            white-space: nowrap; 
            line-height: 1.2; 
        }
        .fmg-cell { 
            background-color: white; 
            color: #333; 
            font-size: 14px; 
            text-align: center; 
            padding: 12px; 
            font-weight: normal; 
            border: none; /* NO BORDERS */
        }
        .fmg-cell:last-child { border-right: none; }
        
        /* OPERATIONAL IMPACTS TABLE */
        .impacts-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 12px; }
        .impacts-table th { padding: 5px; color: #666; font-weight: normal; border-bottom: 2px solid #555; }
        .impacts-table td { padding: 8px; color: #333; font-weight: normal; border-right: 1px solid #f9f9f9; } 
        .impacts-table td:last-child { border-right: none; }
        .impact-label { color: #005EB8; font-weight: normal; text-align: left; padding-left: 10px; border-right: 1px solid #ccc; } 

        /* ALTERNATE ROUTES TABLE */
        .alt-table { width: 100%; border-collapse: collapse; font-size: 12px; text-align: center; }
        .alt-table th { 
            background-color: white; 
            color: black; 
            font-weight: normal; 
            padding: 8px 4px; 
            border-bottom: 1px solid #666;
        }
        .alt-table th:nth-child(2) { font-weight: 600; } 

        .alt-table td { 
            padding: 10px 4px; 
            color: #333; 
            font-weight: normal;
            border-bottom: 1px solid #f2f2f7; 
        }
        .alt-table td:nth-child(2) { font-weight: 600; }
        
        /* ATIS SUBPAGE GRID - NEW STYLES */
        .atis-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; padding: 15px; }
        .atis-box { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border: 1px solid #eee; display: flex; flex-direction: column; }
        
        /* Gray Header (Bianco testo) */
        .atis-header-gray { background-color: #BFBFBF; color: white; font-weight: bold; font-size: 13px; text-align: center; padding: 5px; text-transform: uppercase; }
        
        /* Blue Header (Selected) */
        .atis-header-blue { background-color: #2687E5; color: white; font-weight: bold; font-size: 13px; text-align: center; padding: 5px; text-transform: uppercase; }
        
        .atis-input-area { height: 60px; position: relative; }
        .atis-input { 
            width: 100%; height: 100%; 
            border: none; 
            text-align: center; 
            font-size: 16px; 
            font-weight: normal; 
            color: #000; 
            padding: 5px; 
            box-sizing: border-box; 
            font-family: inherit; 
            background: transparent; 
        }
        .atis-input:focus { background-color: #fafafa; outline: none; }
        
        /* CLEARANCE INPUT */
        .clearance-input {
            width: 100%; 
            height: 50px; 
            border: none; 
            padding: 10px; 
            font-family: inherit; 
            font-size: 18px; 
            text-align: center; 
            font-weight: 600; 
            color: #005EB8; 
            outline: none; 
            background: transparent;
        }

        /* Text Utilities */
        .text-bold { font-weight: 600 !important; }
        .text-normal { font-weight: 400 !important; }
        
        .input-with-t-wrapper { position: relative; display: inline-block; width: 100px; }
        .input-with-t { padding-right: 20px; text-align: right; width: 100%; box-sizing: border-box; border: 1px solid #ccc; padding: 5px; border-radius: 4px; font-weight: bold; }
        .t-suffix { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); color: #000; font-weight: bold; font-size: 12px; }
/* STILE X ROSSA (Normale, non grassetto) */
        .btn-delete-flight {
            background: none; 
            border: none; 
            color: #ff3b30; 
            font-size: 20px; 
            font-weight: normal; /* Modificato: era bold */
            cursor: pointer; 
            padding: 0 10px;
            line-height: 1;
        }
        .btn-delete-flight:hover { 
            color: #d32f2f; 
            background-color: rgba(255, 0, 0, 0.1); 
            border-radius: 4px;
        }
        /* --- STILE NAVLOG (MATCH FUEL/FMC) --- */
.navlog-container-final {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-top: 15px;
    border: none;
}

.navlog-table-final {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    text-align: center;
}

/* Intestazione Blu - Senza righe verticali */
.navlog-header-final {
    background-color: #2687E5;
    color: white;
    font-weight: 600;
    font-size: 13px;
    padding: 8px 4px;
    vertical-align: middle;
    line-height: 1.3;
    text-transform: uppercase;
    border: none; /* RIMOSSO BORDO */
}

/* Celle del corpo tabella - Senza righe orizzontali */
.navlog-row td {
    padding: 6px 4px;
    border: none; /* RIMOSSO BORDO */
    color: #333;
    vertical-align: middle;
}

/* Input manuali (ATO, AFOB, ABRN) */
.navlog-input {
    width: 50px;
    padding: 4px;
    border: 1px solid #ccc; /* Questo bordo rimane per far vedere la casella */
    border-radius: 4px;
    text-align: center;
    font-family: inherit;
    font-size: 13px;
    font-weight: 600;
    color: #000;
}

/* Waypoint (Leggero grassetto) */
.wpt-bold {
    font-weight: 600;
    color: #000;
}
    </style>
</head>
<body>

    <script>
        (function() {
            var pass = localStorage.getItem('efb_pass_v40'); 
            if (pass !== "Ryanair737") { 
                var userIn = prompt("ENTER PASSWORD:");
                if (userIn === "Ryanair737") {
                    localStorage.setItem('efb_pass_v40', userIn);
                } else {
                    document.body.innerHTML = "<div style='display:flex;justify-content:center;align-items:center;height:100vh;color:red;font-weight:bold;font-size:20px;'>ACCESS DENIED</div>";
                    throw new Error("Access Denied");
                }
            }
        })();
    </script>

    <div id="page-home">
        <div id="home-date-header"></div>
        <div class="section-box">
            <div class="section-title">Flight info <button class="btn-main-import" onclick="apriModal()">Refresh</button></div>
            <table id="flight-table">
                <thead><tr><th>Flight</th><th>Callsign</th><th>DEP</th><th>ARR</th><th>STD</th><th>STA</th><th>Date</th><th>Reg</th><th>A/C</th><th>OFP</th></tr></thead>
                <tbody id="flight-table-body"></tbody>
            </table>
            <div id="empty-state" style="text-align: center; padding: 30px; color: #999; font-size: 13px; font-style: italic;">No flight loaded. Click "Refresh".</div>
        </div>
        <div class="section-box">
            <div class="section-title">Crew</div>
            <div id="crew-content" style="color: #005EB8; font-size: 13px; font-style: italic;">No crew members.</div>
        </div>
    </div>

    <div id="import-modal">
        <div class="modal-box">
            <div class="modal-title">Import from SimBrief</div>
            <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #cce5ff;">
                <label style="font-size: 11px; font-weight: bold; color: #005EB8; display: block; margin-bottom: 5px;">SIMBRIEF PILOT ID / USERNAME</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="sb-username" placeholder="e.g. 487768" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-weight: bold; color: #333;">
                    <button onclick="scaricaDaSimBrief()" style="background: #005EB8; color: white; border: none; padding: 8px 12px; border-radius: 5px; font-weight: bold; cursor: pointer;">FETCH</button>
                </div>
                <div id="fetch-status" style="font-size: 10px; color: #666; margin-top: 5px; min-height: 15px;"></div>
            </div>
            <div class="modal-desc" style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">
                <strong>Manual Import (Backup):</strong><br>
                1. <a href="#" id="manual-link" target="_blank" style="color:#007aff;">Click here to open data</a> (Input ID above first)<br>
                2. Select All & Copy<br>
                3. Paste below:
            </div>
            <textarea id="json-input" placeholder="{ ... }"></textarea>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="chiudiModal()">Close</button>
                <button class="btn-confirm" onclick="elaboraDatiManuali()">Load Flight</button>
            </div>
        </div>
    </div>

    <div id="page-details" class="hidden">
        <div id="details-top-bar">
            <div class="nav-row">
                <button class="btn-back-custom" onclick="tornaHome()">&lt; Today's Flights</button>
                <div id="dynamic-page-title" class="page-title-center">FLIGHT LOG</div>
            </div>
            <div id="recap-header" class="flight-header-row">HEADER</div>
        </div>

        <div id="content-area">
            <div id="view-log" class="tab-view"><h2>FLIGHT LOG</h2><p>Loading...</p></div>
            <div id="view-lid" class="tab-view hidden"><h2>LID</h2><p>Content...</p></div>
            
            <div id="view-fuel" class="tab-view hidden">
                </div>

           <div id="view-wpt" class="tab-view hidden">
                <div id="wpt-critical-info" class="section-box" style="text-align: center; font-size: 14px; margin-bottom: 20px; font-weight: normal;">
                    Computing critical data...
                </div>
                
                <div id="navlog-container"></div>
                <div class="navlog-container-final">
    <table class="navlog-table-final">
        <thead>
            <tr>
                <th class="navlog-header-final" style="width: 15%;">AWY<br>POSITION</th>
                <th class="navlog-header-final" style="width: 10%;">FL<br>MORA</th>
                <th class="navlog-header-final" style="width: 10%;">IMT<br>DIS</th>
                <th class="navlog-header-final" style="width: 15%;">WIND<br>SHR</th>
                <th class="navlog-header-final" style="width: 15%;">TTLT<br>ATO</th>
                <th class="navlog-header-final" style="width: 15%;">EFOB<br>AFOB</th>
                <th class="navlog-header-final" style="width: 20%;">PBRN<br>ABRN</th>
            </tr>
        </thead>
        <tbody id="navlog-body-content">
            </tbody>
    </table>
</div>
            </div>
            
            <div id="view-weather" class="tab-view hidden">
                <div class="weather-carousel" id="wx-carousel" onscroll="aggiornaPallini()">
                    <div class="weather-page" id="wx-page-0"></div>
                    <div class="weather-page" id="wx-page-1"></div>
                    <div class="weather-page" id="wx-page-2"></div>
                    <div class="weather-page" id="wx-page-3"></div>
                    <div class="weather-page" id="wx-page-4"></div>
                    <div class="weather-page" id="wx-page-5"></div>
                    <div class="weather-page" id="wx-page-6"></div>
                </div>
                <div class="weather-dots">
                    <span class="dot active" onclick="vaiPaginaMeteo(0)">&#9670;</span><span class="dot" onclick="vaiPaginaMeteo(1)">&#9670;</span><span class="dot" onclick="vaiPaginaMeteo(2)">&#9670;</span><span class="dot" onclick="vaiPaginaMeteo(3)">&#9670;</span><span class="dot" onclick="vaiPaginaMeteo(4)">&#9670;</span><span class="dot" onclick="vaiPaginaMeteo(5)">&#9670;</span><span class="dot" onclick="vaiPaginaMeteo(6)">&#9670;</span>
                </div>
            </div>

            <div id="view-notam" class="tab-view hidden"><h2>NOTAMS</h2><p>Content...</p></div>
            <div id="view-air" class="tab-view hidden"><h2>AIRCRAFT</h2><p>Content...</p></div>
            <div id="view-ofp" class="tab-view hidden"><div id="ofp-text-container">Loading OFP...</div></div>
        </div>

        <div id="bottom-nav">
            <button class="nav-btn active" onclick="cambiaTab('view-log', this, 'FLIGHT LOG')">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M4 12h10M11 8l4 4-4 4" stroke="#005EB8" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/><path d="M19 7v10h2" stroke="#005EB8" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
                <span class="nav-text">Flight Log</span>
            </button>
            <button class="nav-btn" onclick="cambiaTab('view-lid', this, 'LID')">
                <svg class="nav-icon" viewBox="0 0 24 24"><g transform="rotate(-45, 12, 12)"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></g></svg>
                <span class="nav-text">LID</span>
            </button>
            <button class="nav-btn" onclick="cambiaTab('view-fuel', this, 'FUEL/FMC')">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2z" fill="#005EB8" fill-opacity="0.3"/><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z" transform="scale(0.5) translate(24, 24)" fill="#005EB8"/></svg>
                <span class="nav-text">Fuel/FMC</span>
            </button>
            <button class="nav-btn" onclick="cambiaTab('view-wpt', this, 'WAYPOINTS')">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                <span class="nav-text">Waypoints</span>
            </button>
            <button class="nav-btn" onclick="cambiaTab('view-weather', this, 'WEATHER')">
                <svg class="nav-icon" viewBox="0 0 24 24"><circle cx="18" cy="8" r="4" fill="#FFB300"/><path d="M18.5 11C18.2 10.9 17.9 10.9 17.6 11C17.2 8.6 15.2 6.8 12.8 6.8C10.1 6.8 7.8 8.7 7.3 11.3C5.4 11.6 4 13.2 4 15.2C4 17.3 5.7 19 7.8 19H17.8C19.5 19 21 17.5 21 15.8C21 14.3 19.9 13 18.5 12.8V11Z" fill="#00B0FF"/></svg>
                <span class="nav-text">Weather</span>
            </button>
            <button class="nav-btn" onclick="cambiaTab('view-notam', this, 'NOTAMS')">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
                <span class="nav-text">Notams</span>
            </button>
            <button class="nav-btn" onclick="cambiaTab('view-air', this, 'AIRCRAFT')">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                <span class="nav-text">Aircraft</span>
            </button>
            <button class="nav-btn" onclick="cambiaTab('view-ofp', this, 'OFP')">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                <span class="nav-text">OFP</span>
            </button>
        </div>
    </div>

    <div id="subpage-fuel-plan" class="hidden">
        <div id="details-top-bar" style="background:#F1F7FD;">
            <div class="nav-row">
                <button class="btn-back-custom" onclick="chiudiFuelPlanning()">&lt; FUEL/FMC</button>
                <div class="fp-page-title">Fuel Planning</div>
            </div>
            <div id="recap-header-fp" class="flight-header-row">HEADER</div>
        </div>
        <div id="fuel-plan-content" style="padding: 10px; overflow-y:auto; flex-grow:1;">
            </div>
    </div>

    <div id="subpage-dep-atis" class="hidden">
        <div id="details-top-bar" style="background:#F1F7FD;">
            <div class="nav-row">
                <button class="btn-back-custom" onclick="chiudiAtisPage()">&lt; FUEL/FMC</button>
                <div class="fp-page-title">Departure ATIS</div>
            </div>
            <div id="recap-header-atis" class="flight-header-row">HEADER</div>
        </div>
        <div id="atis-content" style="padding: 10px; overflow-y:auto; flex-grow:1;">
            <div class="atis-grid">
                <div class="atis-box"><div class="atis-header-blue">AIRPORT</div><div class="atis-input-area"><input id="atis-apt" class="atis-input" type="text" oninput="syncAtisSummary()"></div></div>
                <div class="atis-box"><div class="atis-header-gray">INFO</div><div class="atis-input-area"><input id="atis-info" class="atis-input" type="text" oninput="syncAtisSummary()"></div></div>
                <div class="atis-box"><div class="atis-header-gray">TIME</div><div class="atis-input-area"><input class="atis-input" type="text"></div></div>
                <div class="atis-box"><div class="atis-header-gray">APPR</div><div class="atis-input-area"><input class="atis-input" type="text"></div></div>
                <div class="atis-box"><div class="atis-header-blue">RWY</div><div class="atis-input-area"><input id="atis-rwy" class="atis-input" type="text" oninput="syncAtisSummary()"></div></div>
                <div class="atis-box"><div class="atis-header-gray">TL/Other Info</div><div class="atis-input-area"><input class="atis-input" type="text"></div></div>
                <div class="atis-box"><div class="atis-header-blue">COND</div><div class="atis-input-area"><input id="atis-cond" class="atis-input" type="text" oninput="syncAtisSummary()"></div></div>
                <div class="atis-box"><div class="atis-header-blue">WIND</div><div class="atis-input-area"><input id="atis-wind" class="atis-input" type="text" oninput="syncAtisSummary()"></div></div>
                <div class="atis-box"><div class="atis-header-gray">VIS</div><div class="atis-input-area"><input class="atis-input" type="text"></div></div>
                <div class="atis-box"><div class="atis-header-gray">WX</div><div class="atis-input-area"><input class="atis-input" type="text"></div></div>
                <div class="atis-box"><div class="atis-header-gray">CLOUD</div><div class="atis-input-area"><input class="atis-input" type="text"></div></div>
                <div class="atis-box"><div class="atis-header-blue">OAT</div><div class="atis-input-area"><input id="atis-oat" class="atis-input" type="text" oninput="syncAtisSummary()"></div></div>
                <div class="atis-box"><div class="atis-header-gray">DP</div><div class="atis-input-area"><input class="atis-input" type="text"></div></div>
                <div class="atis-box"><div class="atis-header-blue">QNH</div><div class="atis-input-area"><input id="atis-qnh" class="atis-input" type="text" oninput="syncAtisSummary()"></div></div>
                <div class="atis-box"><div class="atis-header-gray">Additional Info</div><div class="atis-input-area"><input class="atis-input" type="text"></div></div>
            </div>
        </div>
    </div>
    <div id="subpage-arr-atis" class="hidden">
    <div id="details-top-bar" style="background:#F1F7FD;">
        <div class="nav-row">
            <button class="btn-back-custom" onclick="chiudiArrAtisPage()">&lt; FUEL/FMC</button>
            <div class="fp-page-title">Arrival ATIS</div>
        </div>
        <div id="recap-header-arr-atis" class="flight-header-row">HEADER</div>
    </div>
    <div id="atis-arr-content" style="padding: 10px; overflow-y:auto; flex-grow:1;">
        <div class="atis-grid">
            <div class="atis-box"><div class="atis-header-blue">AIRPORT</div><div class="atis-input-area"><input id="atis-arr-apt" class="atis-input" type="text" oninput="syncArrAtisSummary()"></div></div>
            <div class="atis-box"><div class="atis-header-gray">INFO</div><div class="atis-input-area"><input id="atis-arr-info" class="atis-input" type="text" oninput="syncArrAtisSummary()"></div></div>
            <div class="atis-box"><div class="atis-header-gray">TIME</div><div class="atis-input-area"><input class="atis-input" type="text"></div></div>
            <div class="atis-box"><div class="atis-header-gray">APPR</div><div class="atis-input-area"><input class="atis-input" type="text"></div></div>
            <div class="atis-box"><div class="atis-header-blue">RWY</div><div class="atis-input-area"><input id="atis-arr-rwy" class="atis-input" type="text" oninput="syncArrAtisSummary()"></div></div>
            <div class="atis-box"><div class="atis-header-gray">TL/Other Info</div><div class="atis-input-area"><input class="atis-input" type="text"></div></div>
            <div class="atis-box"><div class="atis-header-blue">COND</div><div class="atis-input-area"><input id="atis-arr-cond" class="atis-input" type="text" oninput="syncArrAtisSummary()"></div></div>
            <div class="atis-box"><div class="atis-header-blue">WIND</div><div class="atis-input-area"><input id="atis-arr-wind" class="atis-input" type="text" oninput="syncArrAtisSummary()"></div></div>
            <div class="atis-box"><div class="atis-header-gray">VIS</div><div class="atis-input-area"><input class="atis-input" type="text"></div></div>
            <div class="atis-box"><div class="atis-header-gray">WX</div><div class="atis-input-area"><input class="atis-input" type="text"></div></div>
            <div class="atis-box"><div class="atis-header-gray">CLOUD</div><div class="atis-input-area"><input class="atis-input" type="text"></div></div>
            <div class="atis-box"><div class="atis-header-blue">OAT</div><div class="atis-input-area"><input id="atis-arr-oat" class="atis-input" type="text" oninput="syncArrAtisSummary()"></div></div>
            <div class="atis-box"><div class="atis-header-gray">DP</div><div class="atis-input-area"><input class="atis-input" type="text"></div></div>
            <div class="atis-box"><div class="atis-header-blue">QNH</div><div class="atis-input-area"><input id="atis-arr-qnh" class="atis-input" type="text" oninput="syncArrAtisSummary()"></div></div>
            <div class="atis-box"><div class="atis-header-gray">Additional Info</div><div class="atis-input-area"><input class="atis-input" type="text"></div></div>
        </div>
    </div>
</div>

    <script>
        // --- VARIABILI GLOBALI ---
        var datiVoloGlobali = null; // Il volo attualmente APERTO/VISUALIZZATO
        var elencoVoli = [];        // La lista storica dei voli importati

        // --- INIZIALIZZAZIONE ---
        (function() {
            var pass = localStorage.getItem('efb_pass_v41'); 
            if (pass !== "Ryanair737") { 
                var userIn = prompt("ENTER PASSWORD:");
                if (userIn === "Ryanair737") {
                    localStorage.setItem('efb_pass_v41', userIn);
                } else {
                    document.body.innerHTML = "<div style='display:flex;justify-content:center;align-items:center;height:100vh;color:red;font-weight:bold;font-size:20px;'>ACCESS DENIED</div>";
                    throw new Error("Access Denied");
                }
            }
        })();

        window.onload = function() {
            // Data Header
            let d = new Date();
            let day = String(d.getDate()).padStart(2, '0');
            let month = String(d.getMonth() + 1).padStart(2, '0'); 
            let year = d.getFullYear();
            let today = `${day}/${month}/${year}`;
            document.getElementById('home-date-header').innerText = today;
            
            // Username Salvato
            let savedUser = localStorage.getItem('sb_username');
            if(savedUser) {
                document.getElementById('sb-username').value = savedUser;
                updateManualLink(savedUser);
            }

            // Recupera voli salvati (se vuoi che rimangano anche chiudendo il browser)
            let savedFlightsData = localStorage.getItem('efb_flight_history');
            if (savedFlightsData) {
                try {
                    elencoVoli = JSON.parse(savedFlightsData);
                    aggiornaTabellaVoli();
                } catch(e) { console.error("Errore lettura storico voli", e); }
            }
        };

        // --- GESTIONE IMPORTAZIONE ---
        document.getElementById('sb-username').addEventListener('input', function(e) {
            updateManualLink(e.target.value);
        });

        function updateManualLink(id) {
            let link = document.getElementById('manual-link');
            if(id) link.href = `https://www.simbrief.com/api/xml.fetcher.php?userid=${id}&json=1`;
            else link.href = "#";
        }

        function apriModal() { document.getElementById('import-modal').style.display = 'flex'; }
        function chiudiModal() { document.getElementById('import-modal').style.display = 'none'; }

        async function scaricaDaSimBrief() {
            let username = document.getElementById('sb-username').value.trim();
            let statusDiv = document.getElementById('fetch-status');
            
            if(!username) { alert("Please enter Pilot ID."); return; }

            localStorage.setItem('sb_username', username);
            statusDiv.innerText = "Connecting to SimBrief...";
            statusDiv.style.color = "#005EB8";

            // URL SimBrief
            let url = `https://www.simbrief.com/api/xml.fetcher.php?userid=${username}&json=1`;

            try {
                let response = await fetch(url);
                if (!response.ok) throw new Error("Connection error");
                let data = await response.json();
                if (!data || !data.general) throw new Error("Invalid data.");

                // NUOVA LOGICA: Aggiungi alla lista invece di sovrascrivere subito
                aggiungiVoloALista(data);
                
                statusDiv.innerText = "Flight imported!";
                statusDiv.style.color = "green";
                setTimeout(chiudiModal, 500);

            } catch (e) {
                statusDiv.innerText = "Error: " + e.message;
                statusDiv.style.color = "red";
                alert("Import Error: " + e.message);
            }
        }

        function elaboraDatiManuali() {
            var testo = document.getElementById('json-input').value.trim();
            if(!testo) return;
            var inizio = testo.indexOf('{');
            var fine = testo.lastIndexOf('}');
            if (inizio === -1 || fine === -1) { alert("No valid JSON found."); return; }
            
            try { 
                var data = JSON.parse(testo.substring(inizio, fine + 1)); 
                aggiungiVoloALista(data);
                chiudiModal(); 
            } catch (e) { alert("Error parsing data: " + e.message); }
        }

        // --- GESTIONE LISTA VOLI (CORE LOGIC) ---
        function aggiungiVoloALista(data) {
            // Identificativo unico del volo (es. request_id o generated time)
            let flightId = data.params.request_id || (data.general.flight_number + data.params.time_generated);

            // Controlla se esiste già
            let index = elencoVoli.findIndex(v => {
                let vId = v.params.request_id || (v.general.flight_number + v.params.time_generated);
                return vId === flightId;
            });

            if (index > -1) {
                // Se esiste, aggiornalo (spostalo in cima?)
                elencoVoli[index] = data;
                // Opzionale: spostalo in cima
                elencoVoli.splice(index, 1);
                elencoVoli.unshift(data);
            } else {
                // Se è nuovo, aggiungi in cima
                elencoVoli.unshift(data);
            }

            // Limita la storia a, diciamo, 5 voli per non appesantire
            if (elencoVoli.length > 5) elencoVoli.pop();

            // Salva in LocalStorage
            localStorage.setItem('efb_flight_history', JSON.stringify(elencoVoli));

            // Aggiorna UI e apri l'ultimo importato
            aggiornaTabellaVoli();
            
        }

        function aggiornaTabellaVoli() {
            let tbody = document.getElementById('flight-table-body');
            let emptyState = document.getElementById('empty-state');
            
            tbody.innerHTML = ""; 

            if (elencoVoli.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            elencoVoli.forEach((volo, index) => {
                let flightNum = volo.general.icao_airline + volo.general.flight_number;
                let callsign = volo.atc.callsign;
                let dep = volo.origin.iata_code;
                let arr = volo.destination.iata_code;
                let std = new Date(volo.times.sched_out * 1000).toISOString().substr(11, 5);
                let sta = new Date(volo.times.sched_in * 1000).toISOString().substr(11, 5);
                
                // --- MODIFICA DATA (dd/mm/yyyy) ---
                let dObj = new Date(volo.times.sched_out * 1000);
                let day = String(dObj.getDate()).padStart(2, '0');
                let month = String(dObj.getMonth() + 1).padStart(2, '0');
                let year = dObj.getFullYear();
                let date = `${day}/${month}/${year}`;
                // ----------------------------------

                let reg = volo.aircraft.reg;
                let config = volo.aircraft.name;
                let release = volo.general.release;

                let row = `
                    <tr onclick="apriVolo(${index})">
                        <td>${flightNum}</td>
                        <td>${callsign}</td>
                        <td>${dep}</td>
                        <td>${arr}</td>
                        <td>${std}</td>
                        <td>${sta}</td>
                        <td>${date}</td>
                        <td>${reg}</td>
                        <td>${config}</td>
                        <td style="text-align:center;">${release}</td>
                        <td style="text-align:center;" onclick="rimuoviVolo(event, ${index})"><button class="btn-delete-flight">&times;</button></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function apriVolo(index) {
            // Carica i dati globali dal volo selezionato nell'array
            if (!elencoVoli[index]) return;
            
            datiVoloGlobali = elencoVoli[index]; // Setta il volo attivo
            popolaDettagli(datiVoloGlobali);     // Popola tutte le pagine
            
            // Switch vista
            document.getElementById('page-home').classList.add('hidden');
            document.getElementById('page-details').classList.remove('hidden');
        }

        // --- POPOLAMENTO PAGINE (Ex popolaApp, ora diviso) ---
        function popolaDettagli(data) {
            // CREW
            let crewHtml = '<table class="crew-table"><tbody>';
            const genCode = () => Math.random().toString(36).substring(2, 7).toUpperCase();
            let crew = data.crew || {};
            
            if (crew.cpt) { crewHtml += `<tr><td class="crew-role">CP</td><td class="crew-code">${genCode()}</td><td class="crew-name">${formatName(crew.cpt)}</td></tr>`; }
            if (crew.fo) { crewHtml += `<tr><td class="crew-role">FO</td><td class="crew-code">${genCode()}</td><td class="crew-name">${formatName(crew.fo)}</td></tr>`; }
            if (crew.pu) { crewHtml += `<tr><td class="crew-role">PU</td><td class="crew-code">${genCode()}</td><td class="crew-name">${formatName(crew.pu)}</td></tr>`; }
            if (crew.fa && Array.isArray(crew.fa)) {
                crew.fa.slice(0, 3).forEach(name => {
                    crewHtml += `<tr><td class="crew-role">FA</td><td class="crew-code">${genCode()}</td><td class="crew-name">${formatName(name)}</td></tr>`;
                });
            }
            crewHtml += '</tbody></table>';
            document.getElementById('crew-content').innerHTML = crewHtml;

            // OFP TEXT
            let ofpText = "";
            if (data.text && data.text.plan_html) {
                ofpText = data.text.plan_html;
            } else if (data.text && data.text.plan_text) {
                ofpText = `<pre>${data.text.plan_text}</pre>`;
            } else {
                ofpText = "OFP Data not available in SimBrief JSON.";
            }
            document.getElementById('ofp-text-container').innerHTML = ofpText;

            // HEADER RECAP
            let d = new Date(data.times.sched_out * 1000);
            let day = String(d.getDate()).padStart(2, '0');
            let month = String(d.getMonth() + 1).padStart(2, '0');
            let year = d.getFullYear();
            let dateFormatted = `${day}/${month}/${year}`;
            
            let flightNum = data.general.icao_airline + data.general.flight_number;
            let std = new Date(data.times.sched_out * 1000).toISOString().substr(11, 5);
            let sta = new Date(data.times.sched_in * 1000).toISOString().substr(11, 5);

            let headerHTML = `<span class="header-callsign">${data.atc.callsign}</span> &nbsp; ${dateFormatted} &nbsp; ${flightNum} &nbsp; ${data.aircraft.reg} &nbsp; ${data.origin.iata_code} &nbsp; ${data.destination.iata_code} &nbsp; ${std} &nbsp; ${sta} &nbsp; ${data.aircraft.icaocode} &nbsp; Y${data.aircraft.max_passengers} &nbsp; OFP${data.general.release}`;
            document.getElementById('recap-header').innerHTML = headerHTML;
            document.getElementById('recap-header-fp').innerHTML = headerHTML;
            document.getElementById('recap-header-atis').innerHTML = headerHTML;
document.getElementById('recap-header-arr-atis').innerHTML = headerHTML;
            // POPOLA ALTRE PAGINE
            aggiornaMeteo(data);
            aggiornaFlightLog(data);
            aggiornaFuelPage(data);
            aggiornaWaypoints(data);
            aggiornaNavLogTable(data)
            
            // ATIS INIT
            syncAtisSummary(); 
        }

        // --- UTILS ---
        function formatName(str) {
            if (!str) return "";
            return str.toLowerCase().split(' ').map(function(word) {
                return word.charAt(0).toUpperCase() + word.slice(1);
            }).join(' ');
        }
        
        function tornaHome() {
            document.getElementById('page-details').classList.add('hidden');
            document.getElementById('page-home').classList.remove('hidden');
            // Quando torno alla home, aggiorno la tabella per sicurezza
            aggiornaTabellaVoli();
        }

        function cambiaTab(idTab, bottone, titoloPagina) {
            document.querySelectorAll('.tab-view').forEach(el => el.classList.add('hidden'));
            var el = document.getElementById(idTab);
            el.classList.remove('hidden');
            document.getElementById('dynamic-page-title').innerText = titoloPagina;
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            bottone.classList.add('active');
        }

        function vaiPaginaMeteo(indice) {
            var carousel = document.getElementById('wx-carousel');
            var width = carousel.offsetWidth;
            carousel.scrollTo({ left: width * indice, behavior: 'smooth' });
        }

        function aggiornaPallini() {
            var carousel = document.getElementById('wx-carousel');
            var width = carousel.offsetWidth;
            var scrollPos = carousel.scrollLeft;
            var indice = Math.round(scrollPos / width);
            var dots = document.getElementsByClassName('dot');
            for (var i = 0; i < dots.length; i++) { dots[i].classList.remove('active'); }
            if(dots[indice]) { dots[indice].classList.add('active'); }
        }

        function formatTime(input) {
            if (!input) return "";
            let d; if (!isNaN(input)) { d = new Date(input * 1000); } else { d = new Date(input); }
            if (isNaN(d.getTime())) return input;
            let day = d.getUTCDate();
            let months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            let month = months[d.getUTCMonth()];
            let hh = String(d.getUTCHours()).padStart(2, '0');
            let mm = String(d.getUTCMinutes()).padStart(2, '0');
            return `${day} ${month} at ${hh}:${mm} UTC`;
        }

        // ... TUTTE LE ALTRE FUNZIONI HELPER (analizzaMetar, calcolaVentoHtml, etc.) RIMANGONO UGUALI ...
        // ... ASSICURATI DI INCLUDERE LE FUNZIONI DI METEO E FUEL PAGE QUI SOTTO ...
        
        function analizzaMetar(metar, sbVis, sbCeil) {
            let cat = "VMC"; let catClass = "bg-green";
            let visDisplay = sbVis ? sbVis : "N/A";
            let ceilDisplay = sbCeil ? sbCeil : "N/A";
            let windDir = 0; let windSpd = 0;
            if (metar) {
                let windMatch = metar.match(/(\d{3}|VRB)(\d{2,3})(G\d{2,3})?KT/);
                if (windMatch) { windDir = (windMatch[1] === "VRB") ? 0 : parseInt(windMatch[1]); windSpd = parseInt(windMatch[2]); }
            }
            if (!metar || metar === "N/A") return { cat: "N/A", catClass: "bg-green", ceiling: ceilDisplay, vis: visDisplay, wd: windDir, ws: windSpd };
            let visValue = 9999; let ceilingValue = 99999;
            if (metar.includes("CAVOK")) { visValue = 10000; ceilingValue = 99999; } else {
                let visMatch = metar.match(/\b(\d{4})\b/);
                if (visMatch) visValue = parseInt(visMatch[1]);
                let cloudRegex = /(BKN|OVC)(\d{3})/g;
                let match; let cloudsFound = [];
                while ((match = cloudRegex.exec(metar)) !== null) { cloudsFound.push(parseInt(match[2]) * 100); }
                if (cloudsFound.length > 0) ceilingValue = Math.min(...cloudsFound);
            }
            if (visValue < 5000 || ceilingValue < 1500) { cat = "IMC"; catClass = "bg-red"; }
            return { cat, catClass, ceiling: ceilDisplay, vis: visDisplay, wd: windDir, ws: windSpd };
        }

        function calcolaVentoHtml(plannedRwy, windDir, windSpd) {
            if(!plannedRwy) return { html: "-", rwyNum: "" };
            let rwyNumStr = plannedRwy.replace(/\D/g, '');
            let rwyNum = parseInt(rwyNumStr);
            if(isNaN(rwyNum)) return { html: "-", rwyNum: plannedRwy };
            let rwyHdg = rwyNum * 10;
            let rad = (windDir - rwyHdg) * (Math.PI / 180);
            let hw = Math.round(windSpd * Math.cos(rad));
            let xw = Math.round(windSpd * Math.sin(rad));
            let hwLabel = "";
            if (hw > 0) hwLabel = `↓ ${Math.abs(hw)}`; else if (hw < 0) hwLabel = `↑ ${Math.abs(hw)}`; else hwLabel = "-";
            let xwLabel = "";
            if (xw > 0) xwLabel = `← ${Math.abs(xw)}`; else if (xw < 0) xwLabel = `→ ${Math.abs(xw)}`; else xwLabel = "-";
            let html = `<span class="wind-val" style="color:#000000; font-weight:normal;">${hwLabel}</span> &nbsp; <span class="wind-val" style="color:#000000; font-weight:normal;">${xwLabel}</span>`;
            return { html, rwyNum: plannedRwy };
        }

        function getRunwayInfoHtml(plannedRwy, windDir, windSpd, runwayLengthM) {
            if (!plannedRwy) return "";
            let windData = calcolaVentoHtml(plannedRwy, windDir, windSpd);
            let dimStr = runwayLengthM ? runwayLengthM + "m" : "N/A";
            return `<div class="runway-section"><div class="rwy-box"><span class="rwy-label">Planned Runway</span><span class="rwy-value">${plannedRwy}</span></div><div class="rwy-box"><span class="rwy-label">Wind Component</span><div style="display:flex; align-items:center;">${windData.html}</div></div><div class="rwy-box"><span class="rwy-label">Runway Length</span><span class="rwy-value">${dimStr}</span></div></div>`;
        }

        function extractRunwayLength(data, type, plannedRwy) {
            if (data.tlr && data.tlr[type] && data.tlr[type].runway) {
                let runways = data.tlr[type].runway;
                if (!Array.isArray(runways)) runways = [runways];
                let found = runways.find(r => r.identifier == plannedRwy);
                if (found && found.length) return Math.round(parseInt(found.length) * 0.3048);
            }
            let airport = (type === 'takeoff') ? (data.origin.runway || data.origin.runways) : (data.destination.runway || data.destination.runways);
            if (airport) {
                if (!Array.isArray(airport)) airport = [airport];
                let found = airport.find(r => (r.ident == plannedRwy) || (r.identifier == plannedRwy));
                if (found) { let len = found.length_ft || found.length; if (len) return Math.round(parseInt(len) * 0.3048); }
            }
            return null;
        }

        function aggiornaMeteo(data) {
            var container = document.getElementById('wx-page-0');
            container.innerHTML = ""; 
            
            // --- 1. PARTE TESTUALE (METAR/TAF) - INVARIATA ---
            if (data.weather) {
                var w = data.weather;
                let depPlan = data.origin.plan_rwy || data.origin.planned_runway;
                if (!depPlan && data.tlr && data.tlr.takeoff && data.tlr.takeoff.conditions) { depPlan = data.tlr.takeoff.conditions.planned_runway; }
                let depLenM = extractRunwayLength(data, 'takeoff', depPlan);
                var depMetar = data.origin.metar || (w ? w.origin_metar : "") || "N/A";
                var depTaf = data.origin.taf || (w ? w.origin_taf : "") || "N/A";
                var depElev = data.origin.elevation + " ft";
                var depMTime = formatTime(data.origin.metar_time);
                var depTTime = formatTime(data.origin.taf_time);
                var depStats = analizzaMetar(depMetar, data.origin.metar_visibility, data.origin.metar_ceiling);
                var depRunwayHTML = getRunwayInfoHtml(depPlan, depStats.wd, depStats.ws, depLenM);
                container.innerHTML += creaBoxMeteo("DEPARTURE AIRPORT", data.origin.icao_code + " / " + data.origin.iata_code, data.origin.name, depMetar, depTaf, "wx-dep", depElev, depStats, depMTime, depTTime, depRunwayHTML);

                let destPlan = data.destination.plan_rwy || data.destination.planned_runway;
                if (!destPlan && data.tlr && data.tlr.landing && data.tlr.landing.conditions) { destPlan = data.tlr.landing.conditions.planned_runway; }
                let destLenM = extractRunwayLength(data, 'landing', destPlan);
                var arrMetar = data.destination.metar || (w ? w.destination_metar : "") || "N/A";
                var arrTaf = data.destination.taf || (w ? w.destination_taf : "") || "N/A";
                var arrElev = data.destination.elevation + " ft";
                var arrMTime = formatTime(data.destination.metar_time);
                var arrTTime = formatTime(data.destination.taf_time);
                var arrStats = analizzaMetar(arrMetar, data.destination.metar_visibility, data.destination.metar_ceiling);
                var arrRunwayHTML = getRunwayInfoHtml(destPlan, arrStats.wd, arrStats.ws, destLenM);
                container.innerHTML += creaBoxMeteo("ARRIVAL AIRPORT", data.destination.icao_code + " / " + data.destination.iata_code, data.destination.name, arrMetar, arrTaf, "wx-arr", arrElev, arrStats, arrMTime, arrTTime, arrRunwayHTML);

                if (data.alternate) {
                    let alternates = Array.isArray(data.alternate) ? data.alternate : [data.alternate];
                    alternates.forEach((alt, index) => {
                        let altMetar = alt.metar || (w ? w.alternate_metar : "") || "N/A";
                        let altTaf = alt.taf || (w ? w.alternate_taf : "") || "N/A";
                        let altElev = alt.elevation + " ft";
                        let altMTime = formatTime(alt.metar_time);
                        let altTTime = formatTime(alt.taf_time);
                        var altStats = analizzaMetar(altMetar, alt.metar_visibility, alt.metar_ceiling);
                        container.innerHTML += creaBoxMeteo(`ALTERNATE AIRPORT ${index + 1}`, alt.icao_code + " / " + alt.iata_code, alt.name, altMetar, altTaf, "wx-alt-" + index, altElev, altStats, altMTime, altTTime, "");
                    });
                }
            }

            // --- 2. PARTE MAPPE (AGGIORNATA) ---
            const injectMap = (pageId, filename, mapName) => {
                let page = document.getElementById(pageId);
                if(!page) return;
                
                // Base URL fissa di SimBrief
                let baseUrl = "https://www.simbrief.com/ofp/uads/";
                // Nome file preso direttamente dal JSON (es. GMFFLFTW_UAD_1770457581_SIGWX12.gif)
                let fullUrl = baseUrl + filename;

                let html = `
                    <div class="map-wrapper">
                        <img src="${fullUrl}" class="wx-map-img" alt="${mapName}" referrerpolicy="no-referrer">
                        <div style="font-size:10px;color:#999;margin-bottom:5px;">${mapName}</div>
                        <a href="${fullUrl}" target="_blank" class="btn-open-map">OPEN MAP</a>
                    </div>
                `;
                page.innerHTML = html;
            };

            // Controlla se esistono immagini nel JSON
            if(data.images && data.images.map) {
                // Assicura che sia un array
                let maps = Array.isArray(data.images.map) ? data.images.map : [data.images.map];
                
                // CICLO SULLE MAPPE
                // Partiamo da i = 1 per SALTARE la prima mappa (che è index 0 = Route)
                // Assegniamo index 1 -> wx-page-1, index 2 -> wx-page-2, ecc.
                for(let i = 1; i < maps.length; i++) {
                     let mapObj = maps[i];
                     let mapFile = mapObj.link; // Il nome file corretto (es. con il "12" finale)
                     let mapName = mapObj.name; // Il nome descrittivo (es. SIGWX FL250-630)
                     
                     // Inietta solo se esiste il contenitore nella pagina (fino a wx-page-6)
                     injectMap(`wx-page-${i}`, mapFile, mapName);
                }
            }
        }

        function creaBoxMeteo(label, codes, name, metar, taf, idUnico, elevation, stats, mTime, tTime, runwayHTML) {
            return `<div class="wx-airport-box"><div class="wx-header-row"><div class="wx-info-left"><span class="wx-label">${label}</span><span class="wx-codes">${codes}</span><span class="wx-name">${name}</span></div><button class="btn-details" onclick="toggleMeteo('${idUnico}', this)">Details <span class="chevron"></span></button></div><div id="${idUnico}" class="wx-details-area"><div class="wx-stats-grid"><div class="stat-box"><span class="stat-label">Elevation</span><span class="stat-value">${elevation}</span></div><div class="stat-box"><span class="stat-label">Category</span><span class="badge-weather ${stats.catClass}">${stats.cat}</span></div><div class="stat-box"><span class="stat-label">Ceiling</span><span class="stat-value">${stats.ceiling}</span></div><div class="stat-box"><span class="stat-label">Visibility</span><span class="stat-value">${stats.vis}</span></div></div>${runwayHTML}<div class="metar-container"><div class="metar-header"><span>METAR</span><span class="header-time">${mTime}</span></div><div class="metar-body">${metar}</div></div><div class="metar-container"><div class="metar-header"><span>TAF</span><span class="header-time">${tTime}</span></div><div class="metar-body">${taf}</div></div></div></div>`;
        }

        function toggleMeteo(id, btn) {
            var el = document.getElementById(id);
            var chevron = btn.querySelector('.chevron');
            if (el.style.display === "block") { el.style.display = "none"; chevron.classList.remove('up'); } else { el.style.display = "block"; chevron.classList.add('up'); }
        }

        function renderImpactsTable(impacts) {
            const getData = (obj, key) => (obj && obj[key] !== undefined) ? obj[key] : null;
            const fmtDiff = (burn, time) => {
                if (burn === null || time === null) return `<td colspan="2">NOT AVAILABLE</td>`;
                let burnVal = parseInt(burn);
                let burnPrefix = burnVal >= 0 ? "P" : "M";
                let burnStr = `TRIP ${burnPrefix}${String(Math.abs(burnVal)).padStart(4, '0')} KGS`; 
                let timeVal = parseInt(time); 
                let mins = Math.round(timeVal / 60);
                let timePrefix = mins >= 0 ? "P" : "M";
                let timeStr = `TIME ${timePrefix}${String(Math.abs(mins)).padStart(4, '0')}`; 
                return `<td>${burnStr}</td><td>${timeStr}</td>`;
            };
            let plus2000 = impacts.plus_2000ft || {};
            let minus2000 = impacts.minus_2000ft || {};
            let plusZfw = impacts.zfw_plus_1000 || {};
            let row1 = fmtDiff(getData(plus2000, 'burn_difference'), getData(plus2000, 'time_difference'));
            let row2 = fmtDiff(getData(minus2000, 'burn_difference'), getData(minus2000, 'time_difference'));
            let row3 = fmtDiff(getData(plusZfw, 'burn_difference'), getData(plusZfw, 'time_difference'));
            return `
                <table class="impacts-table">
                    <tr style="border-bottom: 2px solid #555;">
                        <th style="width: 40%;"></th>
                        <th>TRIP</th>
                        <th>TIME</th>
                    </tr>
                    <tr><td class="impact-label">FL CHANGE</td><td style="text-align:left;">2000 ABOVE</td>${row1}</tr>
                    <tr><td class="impact-label">FL CHANGE</td><td style="text-align:left;">2000 BELOW</td>${row2}</tr>
                    <tr><td class="impact-label">WEIGHT CHANGE UP 1.0</td><td></td>${row3}</tr>
                </table>`;
        }

        function generateAlternateRows(data) {
            let alts = [];
            if (data.alternate) { alts = Array.isArray(data.alternate) ? data.alternate : [data.alternate]; }
            let html = "";
            alts.forEach((alt, index) => {
                let rank = "C" + (index + 1);
                let apt = alt.icao_code + "/" + alt.iata_code;
                let trk = alt.track_mag || alt.track_true || "--";
                let dst = alt.distance || "--";
                let via = alt.route || "--";
                let fl = alt.cruise_altitude ? Math.round(alt.cruise_altitude/100) : "--";
                let mora = alt.mora || ""; 
                let wc = alt.avg_wind_comp || "";
                if(wc && !isNaN(wc)) { wc = (parseInt(wc) >= 0 ? "P" : "M") + String(Math.abs(parseInt(wc))).padStart(3,'0'); }
                let time = formatDuration(alt.ete);
                let fuel = alt.burn;
                html += `<tr><td>${rank}</td><td style="font-weight:600;">${apt}</td><td>${trk}</td><td>${dst}</td><td style="text-align:left; font-size:11px;">${via}</td><td>${fl}</td><td>${mora}</td><td>${wc}</td><td>${time}</td><td>${fuel}</td></tr>`;
            });
            return html;
        }

        function extractWinds(data) {
            let sourceText = "";
            if (data.text && data.text.plan_text) { sourceText = data.text.plan_text; } 
            else {
                let container = document.getElementById('ofp-text-container');
                if(container) sourceText = container.innerText;
            }
            if (!sourceText) return "<div style='text-align:center; padding:10px;'>WIND DATA NOT AVAILABLE</div>";

            let startIdx = sourceText.indexOf("WIND INFORMATION");
            if (startIdx === -1) return "<div style='text-align:center; padding:10px;'>WIND SECTION NOT FOUND</div>";
            let endIdx = sourceText.indexOf("ATC FLIGHT PLAN", startIdx);
            if (endIdx === -1) endIdx = sourceText.indexOf("ICAO FLIGHT PLAN", startIdx);
            if (endIdx === -1) endIdx = startIdx + 3000;

            let windBlock = sourceText.substring(startIdx, endIdx);
            windBlock = windBlock.replace("WIND INFORMATION", "").replace(/----------------/g, "").trim();
            windBlock = windBlock.replace(/DESCENT/g, "<b>DESCENT</b>");

            return `<div class="wind-raw-text">${windBlock}</div>`;
        }

        function toggleWindInfo() {
            let content = document.getElementById('wind-info-content');
            let arrow = document.getElementById('wind-arrow');
            if(content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                arrow.classList.add('rotated');
            } else {
                content.classList.add('hidden');
                arrow.classList.remove('rotated');
            }
        }
function aggiornaWaypoints(data) {
            if (!data.navlog || !data.navlog.fix) return;
            
            let fixes = Array.isArray(data.navlog.fix) ? data.navlog.fix : [data.navlog.fix];
            
            let maxMora = 0; 
            let maxMoraAt = "";
            let maxShr = 0; 
            let maxShrAt = "";
            
            // Recupera codice aeroporto partenza
            let depCode = (data.origin && data.origin.iata_code) ? data.origin.iata_code : "DEP";

            fixes.forEach((f, index) => {
                // --- 1. DEFINIZIONE NOMI ---
                
                // Nome del punto corrente (es. NARGO)
                // Se f.ident è vuoto (capita col TOC/TOD o Departure), prova f.name, o usa fallback
                let currentIdent = f.ident;
                if (!currentIdent || currentIdent.trim() === "") {
                    currentIdent = f.name || f.type || "WPT"; 
                    if (index === 0) currentIdent = depCode;
                }

                // Nome del punto precedente (per la MORA)
                let prevIdent = "";
                if (index === 0) {
                    prevIdent = depCode;
                } else {
                    let prevF = fixes[index - 1];
                    prevIdent = prevF.ident || prevF.name || "WPT";
                }

                // --- 2. CALCOLO MORA (Logica Shift X-1 che ti piaceva) ---
                let m = parseInt(f.mora);
                if (!isNaN(m) && m > maxMora) {
                    maxMora = m;
                    maxMoraAt = prevIdent; 
                }
                
                // --- 3. CALCOLO SHEAR (Logica Diretta - Nessuno Shift) ---
                let s = parseInt(f.shear);
                if (!isNaN(s)) {
                    // Usa >= per prendere l'ultimo punto in caso di pareggio, o > per il primo. 
                    // Uso > qui per prendere il primo che incontra.
                    if (s > maxShr) {
                        maxShr = s;
                        maxShrAt = currentIdent;
                    }
                }
            });

            // Se per caso lo shear è 0, mostriamo comunque 0
            if (maxShrAt === "") maxShrAt = depCode;

            let html = `MOST CRITICAL MORA <b>${maxMora}</b> AT ${maxMoraAt} / MXSHR ${maxShr} AT ${maxShrAt}`;
            
            let container = document.getElementById('wpt-critical-info');
            if(container) container.innerHTML = html;
        }
        function aggiornaFuelPage(data) {
            let f = data.fuel;
            let plannedBlock = f.plan_ramp || 0;
            
            // Popola Main Page FUEL/FMC
            let mainHtml = `
                <div class="section-box-full" style="margin-top:15px;">
                    <div class="fuel-main-grid">
                        <div class="fmg-header">TOTAL FUEL</div>
                        <div class="fmg-header">FINAL BLK</div>
                        <div class="fmg-header"></div> 
                        <div class="fmg-cell" id="main-total-fuel">--</div>
                        <div class="fmg-cell text-bold" id="main-final-blk">-- T</div>
                        <div class="fmg-cell" style="display:flex; justify-content:center; align-items:center;">
                            <a href="#" class="link-text" onclick="apriFuelPlanning()">Fuel Planning &gt;</a>
                        </div>
                    </div>
                </div>
                
                <div class="section-box-full">
                    <div class="fuel-main-grid cols-4">
                        <div class="fmg-header" style="text-transform:none;">eTOW</div>
                        <div class="fmg-header">(MTOW)</div>
                        <div class="fmg-header" style="text-transform:none;">eLW</div>
                        <div class="fmg-header">(MLW)</div>
                        <div class="fmg-cell text-normal">${(data.weights.est_tow / 1000).toFixed(1)}</div>
                        <div class="fmg-cell text-normal">${(data.weights.max_tow_struct / 1000).toFixed(1)}</div>
                        <div class="fmg-cell text-normal">${(data.weights.est_ldw / 1000).toFixed(1)}</div>
                        <div class="fmg-cell text-normal">${(data.weights.max_ldw / 1000).toFixed(1)}</div>
                        <div class="fmg-header">GND DIST</div><div class="fmg-header"></div><div class="fmg-header"></div><div class="fmg-header"></div>
                        <div class="fmg-cell text-bold">${data.general.route_distance}</div><div class="fmg-cell"></div><div class="fmg-cell"></div><div class="fmg-cell"></div>
                    </div>
                </div>

                <div class="section-box-full margin-extra">
                    <div class="fmg-header" style="text-align:left; padding-left:20px;">ALTERNATE ROUTES</div>
                    <div class="fmg-cell" style="padding:0; border:none;">
                        <table class="alt-table">
                            <tr><th>RANK</th><th>APT</th><th>TRK</th><th>DST</th><th>VIA</th><th>FL</th><th>MORA</th><th>WC</th><th>TIME</th><th>FUEL</th></tr>
                            <div style="border-bottom: 1px solid #666;"></div>
                            ${generateAlternateRows(data)}
                        </table>
                    </div>
                </div>

                <div class="section-box-full">
                    <div class="fuel-main-grid">
                        <div class="fmg-header">DEP</div>
                        <div class="fmg-header">ARR</div>
                        <div class="fmg-header">CALLSIGN</div>
                        <div class="fmg-cell text-bold">${data.origin.icao_code}</div>
                        <div class="fmg-cell text-bold">${data.destination.icao_code}</div>
                        <div class="fmg-cell text-bold">${data.atc.callsign}</div>
                    </div>
                </div>

                <div class="section-box-full">
                     <div class="fmg-header" style="text-align:center;">ROUTE</div>
                     <div class="fmg-cell" style="text-align:left; border:none; padding:15px; font-family:inherit; font-size:14px; font-weight:normal; line-height:1.4; border-top:1px solid #f0f0f0;">
                        ${data.origin.icao_code}/${data.origin.plan_rwy} ${data.general.route} ${data.destination.icao_code}/${data.destination.plan_rwy}
                     </div>
                </div>

                <div class="section-box-full">
                    <div class="fuel-main-grid">
                        <div class="fmg-header" style="text-align:left; padding-left:20px;"><span class="text-bold" style="text-transform:none;">eZFW</span></div>
                        <div class="fmg-header"><span class="text-normal">(MZFW)</span></div>
                        <div class="fmg-header" style="text-align:right; padding-right:20px;"><span class="text-bold">CRZ ALT</span></div>
                        <div class="fmg-cell text-bold" style="text-align:left; padding-left:20px;">${(data.weights.est_zfw / 1000).toFixed(1)}</div>
                        <div class="fmg-cell text-normal">${(data.weights.max_zfw / 1000).toFixed(1)}</div>
                        <div class="fmg-cell text-normal" style="text-align:right; padding-right:20px;">${Math.floor(data.general.initial_altitude / 100)}</div>

                        <div class="fmg-header" style="text-align:left; padding-left:20px;"><span class="text-bold">RESERVES</span></div>
                        <div class="fmg-header"><span class="text-normal">(ALTN)</span></div>
                        <div class="fmg-header" style="text-align:right; padding-right:20px;"><span class="text-bold">CRZ WIND</span></div>
                        <div class="fmg-cell text-normal" style="text-align:left; padding-left:20px;">${((parseInt(f.reserve)+parseInt(f.alternate_burn))/1000).toFixed(1)} (${parseInt(f.reserve)+parseInt(f.alternate_burn)})</div>
                        <div class="fmg-cell text-normal" id="alt-code-disp">--</div>
                        <div class="fmg-cell text-normal" id="toc-wind-disp" style="text-align:right; padding-right:20px;">--/--</div>

                        <div class="fmg-header" style="text-align:left; padding-left:20px;"><span class="text-bold">COST INDEX</span></div>
                        <div class="fmg-header"></div>
                        <div class="fmg-header" style="text-align:right; padding-right:20px;"><span class="text-bold">ISA DEV</span></div>
                        <div class="fmg-cell text-normal" id="ci-disp" style="text-align:left; padding-left:20px;">--</div>
                        <div class="fmg-cell"></div>
                        <div class="fmg-cell text-normal" id="isa-dev-disp" style="text-align:right; padding-right:20px;">P000</div>
                    </div>
                </div>
                
                <div class="section-box-full">
                    <div class="fuel-main-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="fmg-header">AVG WIND</div>
                        <div class="fmg-header">FL STEPS</div>
                        <div class="fmg-cell text-normal">${data.general.avg_wind_dir}/${data.general.avg_wind_spd}</div>
                        <div class="fmg-cell text-normal">${data.general.stepclimb_string}</div>
                    </div>
                </div>

                <div class="section-box-full">
                    <div class="fuel-main-grid cols-1">
                         <div class="fmg-header">DEPARTURE ATIS</div>
                         <div class="fmg-cell" style="display:flex; justify-content:space-around; align-items:center; padding:15px; min-height:50px;">
                             <div id="atis-summary-display" style="flex-grow: 1; display: flex; justify-content: space-around; align-items: center; font-size:22px; font-weight:700;"></div> 
                             <a href="#" class="link-text" onclick="apriAtisPage()" style="white-space:nowrap; margin-left: 20px;">Departure ATIS &gt;</a>
                         </div>
                    </div>
                </div>

                <div class="section-box-full">
                     <div class="fuel-main-grid cols-1">
                         <div class="fmg-header">DEPARTURE ATC CLEARANCE</div>
                         <div class="fmg-cell" style="padding: 0;">
                             <input type="text" class="clearance-input" placeholder="">
                         </div>
                     </div>
                </div>

                <div class="section-box-full">
                    <div class="fuel-main-grid cols-1">
                        <div class="fmg-header">OPERATIONAL IMPACTS</div>
                        <div class="fmg-cell" style="padding:0; border:none;">
                            ${renderImpactsTable(data.impacts)}
                        </div>
                    </div>
                </div>

                <div class="section-box-full">
                    <div class="fuel-main-grid cols-1">
                         <div class="fmg-header">ARRIVAL ATIS</div>
                         <div class="fmg-cell" style="display:flex; justify-content:space-around; align-items:center; padding:15px; min-height:50px;">
                             <div id="atis-arr-summary-display" style="flex-grow: 1; display: flex; justify-content: space-around; align-items: center; font-size:22px; font-weight:700;"></div> 
                             <a href="#" class="link-text" onclick="apriArrAtisPage()" style="white-space:nowrap; margin-left: 20px;">Arrival ATIS &gt;</a>
                         </div>
                    </div>
                </div>

                <div class="section-box-full">
                    <div class="fmg-header" style="text-align:left; padding-left:20px; cursor:pointer; display:flex; justify-content:space-between;" onclick="toggleWindInfo()">
                        <span>WIND INFORMATION</span>
                        <span id="wind-arrow" class="wind-arrow">&#9660;</span>
                    </div>
                    <div id="wind-info-content" class="fmg-cell hidden" style="padding:15px; text-align:left; border:none;">
                        ${extractWinds(data)}
                    </div>
                </div>
            `;
            document.getElementById('view-fuel').innerHTML = mainHtml;

            // --- DATA FIXES ---
            let altCode = "NONE";
            if (data.alternate && Array.isArray(data.alternate) && data.alternate.length > 0) {
                altCode = data.alternate[0].iata_code;
            } else if (data.alternate && data.alternate.iata_code) {
                altCode = data.alternate.iata_code;
            }
            document.getElementById('alt-code-disp').innerText = altCode;

            let ci = data.general.costindex || data.general.cost_index || "N/A";
            document.getElementById('ci-disp').innerText = ci;

            if(data.navlog && data.navlog.fix) {
                let fixes = Array.isArray(data.navlog.fix) ? data.navlog.fix : [data.navlog.fix];
                let tocFix = fixes.find(fix => fix.type === "TOC" || fix.ident === "TOC" || fix.name === "TOC");
                if(!tocFix) {
                    tocFix = fixes.find(fix => parseInt(fix.altitude) >= parseInt(data.general.initial_altitude) - 100);
                }
                if(tocFix) {
                    document.getElementById('toc-wind-disp').innerText = `${tocFix.wind_dir}/${tocFix.wind_spd}`;
                    let val = parseInt(tocFix.oat_isa_dev || tocFix.isadev || 0); 
                    let prefix = val >= 0 ? "P" : "M";
                    let valStr = String(Math.abs(val)).padStart(3, '0');
                    document.getElementById('isa-dev-disp').innerText = prefix + valStr;
                }
            }

            renderFuelPlanningSubpage(data);
            syncFinalBlock();
            
            // ATIS Empty Init
            syncAtisSummary();
        }

        // --- ATIS LOGIC (FIXED) ---
        function apriAtisPage() {
            document.getElementById('page-details').classList.add('hidden');
            document.getElementById('subpage-dep-atis').classList.remove('hidden');
        }

        function chiudiAtisPage() {
            document.getElementById('subpage-dep-atis').classList.add('hidden');
            document.getElementById('page-details').classList.remove('hidden');
        }

        function syncAtisSummary() {
            let info = document.getElementById('atis-info').value.toUpperCase();
            let qnh = document.getElementById('atis-qnh').value;
            let html = "";
            if(info) html += `<span>${info}</span>`;
            if(qnh) html += `<span>Q${qnh}</span>`;
            document.getElementById('atis-summary-display').innerHTML = html;
        }
        
        function toggleWindInfo() {
            let content = document.getElementById('wind-info-content');
            let arrow = document.getElementById('wind-arrow');
            if(content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                arrow.classList.add('rotated');
            } else {
                content.classList.add('hidden');
                arrow.classList.remove('rotated');
            }
        }
        
        function extractWinds(data) {
            let sourceText = "";
            if (data.text && data.text.plan_text) {
                sourceText = data.text.plan_text;
            } else {
                let container = document.getElementById('ofp-text-container');
                if(container) sourceText = container.innerText;
            }

            if (!sourceText) return "<div style='text-align:center; padding:10px;'>WIND DATA NOT AVAILABLE</div>";

            let startIdx = sourceText.indexOf("WIND INFORMATION");
            if (startIdx === -1) return "<div style='text-align:center; padding:10px;'>WIND SECTION NOT FOUND</div>";

            let endIdx = sourceText.indexOf("ATC FLIGHT PLAN", startIdx);
            if (endIdx === -1) endIdx = sourceText.indexOf("ICAO FLIGHT PLAN", startIdx);
            if (endIdx === -1) endIdx = startIdx + 3000;

            let windBlock = sourceText.substring(startIdx, endIdx);
            windBlock = windBlock.replace("WIND INFORMATION", "").replace(/----------------/g, "").trim();
            windBlock = windBlock.replace(/DESCENT/g, "<b>DESCENT</b>");

            return `<div class="wind-raw-text">${windBlock}</div>`;
        }

        function renderFuelPlanningSubpage(data) {
            let fpContent = document.getElementById('fuel-plan-content');
            let f = data.fuel;
            let plannedBlock = f.plan_ramp || 0;
            let trip = parseInt(f.enroute_burn || 0);
            let tripTime = formatDuration(data.times.est_time_enroute);
            let cont = parseInt(f.contingency || 0);
            let contTime = formatDuration(data.fuel.contingency_time || data.times.contfuel_time || 0);
            let altCode = "NONE";
            let altTimeVal = 0;
            if (data.alternate && Array.isArray(data.alternate) && data.alternate.length > 0) {
                altCode = data.alternate[0].iata_code;
                altTimeVal = data.alternate[0].ete;
            } else if (data.alternate && data.alternate.iata_code) {
                altCode = data.alternate.iata_code;
                altTimeVal = data.alternate.ete;
            }
            let altBurn = parseInt(f.alternate_burn || 0);
            let altTime = formatDuration(altTimeVal);
            let finRes = parseInt(f.reserve || 0);
            let finResTime = "00:30"; 
            let addRes = parseInt(f.extra_required || 0);
            let addResTime = formatDuration(f.extra_time || 0);
            let plannedTOff = trip + cont + altBurn + finRes + addRes;
            let secPlannedTOff = parseInt(data.times.est_time_enroute || 0) + parseInt(data.fuel.contingency_time || 0) + parseInt(altTimeVal || 0) + 1800 + parseInt(f.extra_time || 0);
            let plannedTOffTime = formatDuration(secPlannedTOff);
            let opn = parseInt(f.extra_optional || 0);
            let opnTime = formatDuration(f.extra_optional_time || 0);
            let tOffFuel = plannedTOff + opn;
            let tOffTime = formatDuration(secPlannedTOff + parseInt(f.extra_optional_time || 0));
            let taxi = parseInt(f.taxi || 0);
            let taxiTime = formatDuration(data.times.taxi_out || 0);
            let depCode = data.origin.iata_code;
            let blockFuel = parseInt(f.plan_ramp || 0); 

            let fpTable = `
                <div class="fp-table">
                    <div class="fp-header-blue">PLANNED FUEL</div>
                    <table style="width:100%; border-collapse:collapse;">
                        <tr class="fp-sub-header"><th>FUEL</th><th>ARPT</th><th style="font-weight:bold;">FUEL</th><th>TIME</th></tr>
                        <tr class="fp-row"><td>TRIP</td><td>${data.destination.iata_code}</td><td>${trip}</td><td>${tripTime}</td></tr>
                        <tr class="fp-row"><td>CONT 5%</td><td></td><td>${cont}</td><td>${contTime}</td></tr>
                        <tr class="fp-row"><td>ALT</td><td>${altCode}</td><td>${altBurn}</td><td>${altTime}</td></tr>
                        <tr class="fp-row"><td>FINAL RES</td><td></td><td>${finRes}</td><td>${finResTime}</td></tr>
                        <tr class="fp-row"><td>ADD RES</td><td></td><td>${addRes}</td><td>${addResTime}</td></tr>
                        <tr class="fp-row-divider"><td colspan="4"></td></tr>
                        <tr class="fp-row"><td>PLANNED T/OFF FUEL</td><td></td><td>${plannedTOff}</td><td>${plannedTOffTime}</td></tr>
                        <tr class="fp-row-divider"><td colspan="4"></td></tr>
                        <tr class="fp-row"><td>OPN</td><td></td><td>${opn}</td><td>${opnTime}</td></tr>
                        <tr class="fp-row-divider"><td colspan="4"></td></tr>
                        <tr class="fp-row"><td>T/OFF FUEL</td><td></td><td>${tOffFuel}</td><td>${tOffTime}</td></tr>
                        <tr class="fp-row"><td>TAXI</td><td>${depCode}</td><td>${taxi}</td><td>${taxiTime}</td></tr>
                        <tr class="fp-row-divider"><td colspan="4"></td></tr>
                        <tr class="fp-row"><td>BLOCK FUEL</td><td>${depCode}</td><td id="fp-block">${blockFuel}</td><td></td></tr>
                        <tr class="fp-row"><td>PIC EXTRA</td><td></td><td><input type="number" id="fp-extra" class="fp-input" placeholder="0" onchange="ricalcolaFuelPlan()"></td><td></td></tr>
                        <tr class="fp-row"><td>TOTAL FUEL</td><td></td><td id="fp-total" style="font-weight:bold;">${blockFuel}</td><td></td></tr>
                        <tr class="fp-row"><td colspan="2" style="font-size:11px;">REASON FOR PIC EXTRA</td><td colspan="2"><input type="text" class="fp-input" style="font-weight:normal;"></td></tr>
                        <tr class="fp-row-divider"><td colspan="4"></td></tr>
                        <tr class="fp-final-row"><td style="font-weight:bold; font-size:14px; color:black;">FINAL BLK</td><td colspan="3"><div class="input-with-t-wrapper"><input type="number" id="fp-final-blk-tons" class="input-with-t" value="${(blockFuel/1000).toFixed(1)}" step="0.1" onchange="syncFinalBlock()"><span class="t-suffix">T</span></div></td></tr>
                    </table>
                </div>
            `;
            fpContent.innerHTML = fpTable;
        }

        function apriFuelPlanning() {
            document.getElementById('page-details').classList.add('hidden');
            document.getElementById('subpage-fuel-plan').classList.remove('hidden');
        }

        function chiudiFuelPlanning() {
            document.getElementById('subpage-fuel-plan').classList.add('hidden');
            document.getElementById('page-details').classList.remove('hidden');
        }

        window.ricalcolaFuelPlan = function() {
            let block = parseInt(document.getElementById('fp-block').innerText);
            let extra = parseInt(document.getElementById('fp-extra').value) || 0;
            let total = block + extra;
            document.getElementById('fp-total').innerText = total;
            let tons = (total / 1000).toFixed(1);
            document.getElementById('fp-final-blk-tons').value = tons;
            syncFinalBlock();
        }

        window.syncFinalBlock = function() {
            let tons = parseFloat(document.getElementById('fp-final-blk-tons').value);
            let totalKg = document.getElementById('fp-total').innerText; 
            let elMainTotal = document.getElementById('main-total-fuel');
            let elMainFinal = document.getElementById('main-final-blk');
            if(elMainTotal) elMainTotal.innerText = totalKg;
            if(elMainFinal) elMainFinal.innerText = tons + " T";
            let dispBlock = document.getElementById('disp-block-fuel');
            if(dispBlock) {
                let kgs = Math.round(tons * 1000);
                dispBlock.innerText = kgs;
                let hiddenInp = document.getElementById('input-final-block'); 
                if(!hiddenInp) {
                    hiddenInp = document.createElement('input');
                    hiddenInp.id = 'input-final-block';
                    hiddenInp.type = 'hidden';
                    document.body.appendChild(hiddenInp);
                }
                hiddenInp.value = kgs;
                calcolaCarburante();
            }
        }

        function formatDuration(sec) {
            if(!sec) return "00:00";
            let h = Math.floor(sec/3600);
            let m = Math.floor((sec%3600)/60);
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
        }

        // --- FLIGHT LOG FUNCTION ---
        function aggiornaFlightLog(data) {
            const fmt = (ts) => ts ? new Date(ts * 1000).toISOString().substr(11, 5) : "--:--";
            const fmtDur = (sec) => {
                if(!sec) return "--:--";
                let h = Math.floor(sec / 3600);
                let m = Math.floor((sec % 3600) / 60);
                return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            };

            let t = data.times;
            let f = data.fuel; 
            
            let html = `
                <div class="log-container">
                    <div class="log-header">
                        <span>FLIGHT TIMES (OOOI)</span>
                    </div>
                    <div class="log-grid">
                        <div class="log-cell log-col-header"></div> 
                        <div class="log-cell log-col-header">SCHED</div>
                        <div class="log-cell log-col-header">EST</div>
                        <div class="log-cell log-col-header">ACTUAL</div>

                        <div class="log-cell log-label">OUT</div>
                        <div class="log-cell log-value-sched">${fmt(t.sched_out)}</div>
                        <div class="log-cell log-value-est">${fmt(t.est_out)}</div>
                        <div class="log-cell"><input type="time" id="act-out" class="log-input" onchange="calcolaTempi()"></div>

                        <div class="log-cell log-label">OFF</div>
                        <div class="log-cell log-value-sched">${fmt(t.sched_off)}</div>
                        <div class="log-cell log-value-est">${fmt(t.est_off)}</div>
                        <div class="log-cell"><input type="time" id="act-off" class="log-input" onchange="calcolaTempi()"></div>

                        <div class="log-cell log-label">ON</div>
                        <div class="log-cell log-value-sched">${fmt(t.sched_on)}</div>
                        <div class="log-cell log-value-est">${fmt(t.est_on)}</div>
                        <div class="log-cell"><input type="time" id="act-on" class="log-input" onchange="calcolaTempi()"></div>

                        <div class="log-cell log-label">IN</div>
                        <div class="log-cell log-value-sched">${fmt(t.sched_in)}</div>
                        <div class="log-cell log-value-est">${fmt(t.est_in)}</div>
                        <div class="log-cell"><input type="time" id="act-in" class="log-input" onchange="calcolaTempi()"></div>

                        <div class="log-cell log-label">BLOCK TIME</div>
                        <div class="log-cell log-value-sched">${fmtDur(t.sched_block)}</div>
                        <div class="log-cell log-value-est">${fmtDur(t.est_block)}</div>
                        <div class="log-cell log-calc-result" id="val-block">--:--</div>

                        <div class="log-cell log-label">FLIGHT TIME</div>
                        <div class="log-cell log-value-sched">${fmtDur(t.sched_time_enroute)}</div>
                        <div class="log-cell log-value-est">${fmtDur(t.est_time_enroute)}</div>
                        <div class="log-cell log-calc-result" id="val-flight">--:--</div>
                    </div>
                </div>

                <div class="log-container">
                    <div class="log-header">
                        <span>FUEL</span>
                    </div>
                    <div class="log-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                        <div class="log-cell log-col-header"></div>
                        <div class="log-cell log-col-header">PLANNED</div>
                        <div class="log-cell log-col-header">ACTUAL</div>
                        <div class="log-cell log-col-header">DIFF</div>

                        <div class="log-cell log-label">BLOCK FUEL</div>
                        <div class="log-cell log-value-sched">${f.plan_ramp}</div>
                        <div class="log-cell" id="disp-block-fuel" style="font-weight:bold; color:#005EB8;">${f.plan_ramp}</div>
                        <div class="log-cell">-</div>

                        <div class="log-cell log-label">ARRIVAL FUEL</div>
                        <div class="log-cell log-value-sched">${f.plan_landing}</div>
                        <div class="log-cell"><input type="number" id="input-arr-fuel" class="log-input" placeholder="KGS" onchange="calcolaCarburante()"></div>
                        <div class="log-cell log-calc-result" id="val-arr-diff">--</div>

                        <div class="log-cell log-label">TRIP FUEL</div>
                        <div class="log-cell log-value-sched">${f.enroute_burn}</div>
                        <div class="log-cell log-calc-result" id="val-act-trip">--</div>
                        <div class="log-cell log-calc-result" id="val-trip-diff">--</div>
                    </div>
                </div>
            `;

            document.getElementById('view-log').innerHTML = html;
        }

        // --- GLOBAL CALCULATION FUNCTIONS ---
        window.calcolaTempi = function() {
            const getMin = (id) => {
                let val = document.getElementById(id).value;
                if(!val) return null;
                let p = val.split(':');
                return parseInt(p[0]) * 60 + parseInt(p[1]);
            };

            const calcDiff = (start, end) => {
                if(start === null || end === null) return "--:--";
                let diff = end - start;
                if(diff < 0) diff += 1440; 
                let h = Math.floor(diff / 60);
                let m = diff % 60;
                return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            };

            let outT = getMin('act-out');
            let offT = getMin('act-off');
            let onT = getMin('act-on');
            let inT = getMin('act-in');

            document.getElementById('val-block').innerText = calcDiff(outT, inT);
            document.getElementById('val-flight').innerText = calcDiff(offT, onT);
        }

        window.calcolaCarburante = function() {
            let dispBlock = document.getElementById('disp-block-fuel');
            let blockFuel = dispBlock ? parseFloat(dispBlock.innerText) : 0;

            let arrInput = document.getElementById('input-arr-fuel');
            let arrFuel = arrInput ? parseFloat(arrInput.value) : 0;

            let plannedTrip = 0;
            let plannedArr = 0;
            if(datiVoloGlobali && datiVoloGlobali.fuel) {
                plannedTrip = parseFloat(datiVoloGlobali.fuel.enroute_burn || 0);
                plannedArr = parseFloat(datiVoloGlobali.fuel.plan_landing || 0);
            }

            if(blockFuel > 0 && arrFuel > 0) {
                let actualTrip = blockFuel - arrFuel;
                document.getElementById('val-act-trip').innerText = actualTrip;

                let diffTrip = actualTrip - plannedTrip;
                let elTripDiff = document.getElementById('val-trip-diff');
                elTripDiff.innerText = (diffTrip > 0 ? "+" : "") + diffTrip;
                elTripDiff.style.color = diffTrip > 0 ? "red" : "green";

                let diffArr = arrFuel - plannedArr;
                let elArrDiff = document.getElementById('val-arr-diff');
                elArrDiff.innerText = (diffArr > 0 ? "+" : "") + diffArr;
                elArrDiff.style.color = diffArr >= 0 ? "green" : "red";
            }
        }
        function rimuoviVolo(event, index) {
            event.stopPropagation(); // Impedisce che il click apra il volo
            if(confirm("Vuoi eliminare questo volo dalla memoria?")) {
                elencoVoli.splice(index, 1); // Rimuove dalla lista
                localStorage.setItem('efb_flight_history', JSON.stringify(elencoVoli)); // Aggiorna memoria
                aggiornaTabellaVoli(); // Ridisegna la tabella
            }
        }
        function aggiornaNavLogTable(data) {
    var tbody = document.getElementById('navlog-body-content');
    tbody.innerHTML = ""; // Pulisci tabella

    if (!data.navlog || !data.navlog.fix) {
        tbody.innerHTML = "<tr><td colspan='7'>No Navlog Data</td></tr>";
        return;
    }

    var fixes = Array.isArray(data.navlog.fix) ? data.navlog.fix : [data.navlog.fix];
    var taxiFuel = parseFloat(data.fuel.taxi || 0);

    // --- RIGA 0: DEPARTURE ---
    let fix0 = fixes[0];
    
    let flDep = ""; // FL Partenza Vuoto
    let moraDep = fix0 ? Math.round(parseInt(fix0.mora)/100) : ""; // MORA Shiftata (del 1° punto)
    
    let efobDep = data.fuel.plan_takeoff || "-";
    let pbrnDep = taxiFuel; // PBRN Partenza = Taxi Fuel

    let rowOrigin = `
        <tr class="navlog-row" style="background-color: #f8fbff;">
            <td>
                <div style="font-size:11px; color:#666;"></div>
                <div class="wpt-bold">${data.origin.icao_code}</div>
            </td>
            <td>
                <div>${flDep}</div>
                <div style="font-size:11px; color:#666;">${moraDep}</div>
            </td>
            <td><div>-</div><div style="font-size:11px; color:#666;">-</div></td>
            <td><div>-</div><div style="font-size:11px; color:#666;">-</div></td>
            <td>
                <div style="margin-bottom:2px;">00:00</div>
                <input type="time" class="navlog-input" style="width:75px;">
            </td>
            <td>
                <div style="margin-bottom:2px;">${efobDep}</div>
                <input type="text" class="navlog-input" placeholder=""> </td>
            <td>
                <div style="margin-bottom:2px;">${pbrnDep}</div>
                <input type="text" class="navlog-input" placeholder=""> </td>
        </tr>
    `;
    tbody.innerHTML += rowOrigin;

    // --- LOOP WAYPOINTS ---
    fixes.forEach((f, index) => {
        let ident = f.ident || f.name || "WPT";
        let awy = f.via_airway || "DCT";
        
        // FL: Punto Corrente (No Shift)
        let fl = f.altitude_feet ? Math.round(parseInt(f.altitude_feet)/100) : "";

        // MORA: Punto Successivo (Shift)
        let nextFix = fixes[index + 1];
        let mora = nextFix ? Math.round(parseInt(nextFix.mora)/100) : "-";

        let imt = f.track_mag || f.track_true || "";
        let dis = f.distance || "";
        let wind = (f.wind_dir && f.wind_spd) ? `${f.wind_dir}/${f.wind_spd}` : "";
        let shr = f.shear || "0";

        // TTLT 
        let ttlt = "--:--";
        let rawTime = f.time_total || f.time_total_enroute;
        if (rawTime) {
            let t = parseInt(rawTime);
            let h = Math.floor(t / 3600);
            let m = Math.floor((t % 3600) / 60);
            ttlt = String(h).padStart(2, '0') + ":" + String(m).padStart(2, '0');
        }

        let efob = f.fuel_plan_onboard || f.efob || "";

        let burnedEnroute = parseFloat(f.fuel_totalused || f.fuel_used || 0);
        let pbrn = Math.round(taxiFuel + burnedEnroute);

        let row = `
            <tr class="navlog-row">
                <td>
                    <div style="font-size:11px; color:#666;">${awy}</div>
                    <div class="wpt-bold">${ident}</div>
                </td>
                <td>
                    <div>${fl}</div>
                    <div style="font-size:11px; color:#666;">${mora}</div>
                </td>
                <td>
                    <div>${imt}°</div>
                    <div style="font-size:11px; color:#666;">${dis} NM</div>
                </td>
                <td>
                    <div>${wind}</div>
                    <div style="font-size:11px; color:#666;">${shr}</div>
                </td>
                <td>
                    <div style="margin-bottom:2px;">${ttlt}</div>
                    <input type="time" class="navlog-input" style="width:75px;">
                </td>
                <td>
                    <div style="margin-bottom:2px;">${efob}</div>
                    <input type="text" class="navlog-input" placeholder=""> </td>
                <td>
                    <div style="margin-bottom:2px;">${pbrn}</div>
                    <input type="text" class="navlog-input" placeholder=""> </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}
// --- ARRIVAL ATIS FUNCTIONS ---
function apriArrAtisPage() {
    document.getElementById('page-details').classList.add('hidden');
    document.getElementById('subpage-arr-atis').classList.remove('hidden');
    
    // Pre-fill Arrival Airport se vuoto
    let aptInput = document.getElementById('atis-arr-apt');
    if(aptInput && !aptInput.value && datiVoloGlobali) {
        aptInput.value = datiVoloGlobali.destination.iata_code;
        syncArrAtisSummary();
    }
}

function chiudiArrAtisPage() {
    document.getElementById('subpage-arr-atis').classList.add('hidden');
    document.getElementById('page-details').classList.remove('hidden');
}

function syncArrAtisSummary() {
    let info = document.getElementById('atis-arr-info').value.toUpperCase();
    let qnh = document.getElementById('atis-arr-qnh').value;

    let html = "";
    if(info) html += `<span>${info}</span>`;
    if(qnh)  html += `<span>Q${qnh}</span>`;

    document.getElementById('atis-arr-summary-display').innerHTML = html;
}
    </script>
</body>
</html>
